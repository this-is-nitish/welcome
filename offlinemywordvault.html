
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Word Vault — Offline Read‑Only</title>
  <style>
    :root{
      --bg:#0b1220; /* slate-950ish */
      --panel:#0f172a; /* slate-900 */
      --ink:#e5e7eb;  /* slate-200 */
      --muted:#94a3b8; /* slate-400 */
      --accent:#8b5cf6; /* violet-500 */
      --accent-2:#22c55e; /* green-500 */
      --danger:#ef4444; /* red-500 */
      --yellow:#fde047; /* yellow-300 */
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 40%,#0b1220);color:var(--ink);font:500 15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif}
    h1{margin:0;font-size:clamp(28px,4vw,42px);font-weight:900;letter-spacing:.3px}
    .app{max-width:1100px;margin:0 auto;padding:20px 16px 64px}

    /* top bar */
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin-top:14px}
    .toolbar .left, .toolbar .right{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .spacer{flex:1}

    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;background:#111827;color:#fff;box-shadow:0 10px 28px rgba(0,0,0,.22)}
    .btn:hover{filter:brightness(1.08)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-alt{background:#e5e7eb;color:#111827}
    .btn-outline{background:transparent;border:1px solid #334155;color:#e5e7eb}
    .btn-ghost{background:transparent;color:#e5e7eb}
    .btn-primary{background:var(--accent)}

    .file{position:relative;overflow:hidden}
    .file input{position:absolute;inset:0;opacity:0;cursor:pointer}

    .field{min-width:260px;max-width:420px;flex:1;background:#111827;color:#e5e7eb;border:1px solid #1f2937;border-radius:10px;padding:11px 12px;font-weight:700}
    .field::placeholder{color:#9ca3af}

    .subtle{color:#a3a3a3}

    .kpis{margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center;font-weight:800}

    /* filters */
    .filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin:12px 0 0}
    .chip{display:inline-flex;gap:8px;align-items:center;background:#111827;border:1px solid #243145;color:#e5e7eb;padding:6px 10px;border-radius:999px;font-weight:800}
    .chip button{background:none;border:none;color:#cbd5e1;font-weight:900;cursor:pointer}

    /* grid */
    #wordsContainer{--card-height:17.5rem;display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-top:18px}
    @media(min-width:980px){#wordsContainer{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:640px){#wordsContainer{grid-template-columns:1fr}}

    /* card */
    .card{position:relative;height:var(--card-height);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));border:1px solid rgba(148,163,184,.18);box-shadow:0 18px 50px rgba(0,0,0,.28);overflow:hidden}
    .card-in{position:absolute;inset:0;display:flex;flex-direction:column}
    .card .head{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px 12px 0}
    .word{font-size:1.2rem;font-weight:900}
    .dot{position:absolute;right:12px;bottom:12px;width:18px;height:18px;border-radius:50%;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.5);cursor:pointer}
    .dot:after{content:'';position:absolute;inset:4px;border-radius:50%;background:linear-gradient(135deg,#0ea5e9,#22c55e)}
    .meta{margin:8px 12px 0;display:flex;gap:6px;flex-wrap:wrap}
    .pill{display:inline-block;padding:.28rem .55rem;border-radius:.75rem;font-size:.82rem;font-weight:800}
    .pill.tag{background:#e9d5ff;color:#6b21a8}
    .pill.syn{background:#dcfce7;color:#166534}
    .pill.ant{background:#fee2e2;color:#991b1b}
    .pill.form{background:rgba(255,255,255,.08);color:#ffeb3b;border:1px dashed rgba(255,255,255,.2)}
    .pill.form .lbl{background:rgba(0,200,255,.15);color:#80eaff;font-size:.72rem;font-weight:900;padding:2px 6px;border-radius:6px;border:1px solid rgba(0,200,255,.3);margin-left:6px}

    .body{flex:1;overflow:auto;padding:8px 12px 0}
    .def{display:flex;gap:10px;align-items:flex-start;background:transparent;color:blue;border-radius:10px;padding:10px;border:1px dashed rgba(255,255,255,.08);margin-bottom:10px}
    .num{min-width:30px;height:30px;border-radius:999px;background:#0b1220;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-weight:900}
    .pos{display:inline-block;padding:.18rem .5rem;border-radius:.6rem;font-weight:900;font-size:.75rem;margin-left:.5rem;background:#f3e8ff;color:#6b21a8;cursor:pointer}
    .pos.verb{background:#e0f2fe;color:#075985}
    .pos.adjective{background:#fff1f2;color:#9f1239}
    .pos.adverb{background:#dcfce7;color:#166534}

    .token{outline:none;display:inline-block;margin:.12rem;padding:.28rem .5rem;border-radius:.6rem;font-weight:800}
    .token.clickable{cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.12)}
    .token.disabled{opacity:.6;cursor:not-allowed;filter:grayscale(.25)}

    .def-text .token{display:inline;padding:0;margin:0 .12rem;border-radius:0}
    .def-text .token.xref{text-decoration:underline dotted;text-underline-offset:2px;cursor:pointer}

    /* stars */
    .stars{font-size:18px;user-select:none;display:inline-flex;gap:2px}
    .stars span{opacity:.5}
    .stars span.f{opacity:1}

    /* modal */
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:70;background:rgba(2,6,23,.55);backdrop-filter:blur(6px);padding:22px}
    .modal{width:100%;max-width:880px;border-radius:14px;padding:18px;background:linear-gradient(180deg,#ffffff,#f8fafc);color:#0f172a;box-shadow:0 24px 60px rgba(2,6,23,.45);position:relative}
    .close{position:absolute;right:12px;top:12px;background:#111827;color:#fff;border-radius:999px;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .modal .actions{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}
    .hidden{display:none}

    /* layout toggles */
    .subtoolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin-top:10px}

    /* printable */
    @media print{.toolbar,.subtoolbar,.filters,.kpis,.modal,.overlay,#modalGlobalNav{display:none !important}body{background:#fff;color:#000;margin:8mm}}

    /* Global modal nav */
    #modalGlobalNav{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;height:56px;align-items:center;gap:10px;background:rgba(255,255,255,.96);border-radius:999px;padding:8px 12px;box-shadow:0 14px 40px rgba(0,0,0,.25);z-index:120}
    #modalGlobalNav button{background:#2563eb;color:#fff;border:none;border-radius:8px;padding:8px 10px;font-weight:900;cursor:pointer}
    #modalGlobalNav .light{background:#e5e7eb;color:#111827}
  </style>
</head>
<body>
  <div class="app">
    <header class="txt-center">
      <h1>📚 My Word Vault</h1>
      <div class="subtle" style="text-align:center;margin-top:4px">Offline • Read‑Only viewer (load your JSON and explore)</div>
    </header>

    <div class="toolbar" role="region" aria-label="Controls">
      <div class="left">
        <label class="btn file" title="Load your JSON file (export)">Load JSON…<input id="jsonFile" type="file" accept="application/json"></label>
        <button id="btnAutoLoad" class="btn-outline">Try auto‑load <code>words.json</code></button>
        <button id="btnPrintable" class="btn-primary">Printable</button>
        <button id="btnThesaurus" class="btn-outline">Thesaurus</button>
      </div>
      <div class="spacer"></div>
      <div class="right">
        <input id="search" class="field" placeholder="Search words, tags, defs, syn/ant, forms…" />
        <button id="btnClear" class="btn-ghost" title="Clear search">Clear</button>
        <button id="btnLayout" class="btn-outline" title="Cycle card size">Size: Normal</button>
      </div>
    </div>

    <div class="kpis"><span id="wordCount">0</span> words</div>

    <div class="subtoolbar">
      <div class="btn-outline" style="display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px">
        Stars filter:
        <button class="btn-outline star-btn" data-value="1" title="Show ★ only">★</button>
        <button class="btn-outline star-btn" data-value="2" title="Show ★★ only">★★</button>
        <button class="btn-outline star-btn" data-value="3" title="Show ★★★ only">★★★</button>
        <button id="starClearBtn" class="btn-outline" title="Show all">All</button>
      </div>
      <div id="activeFilterContainer" class="filters" aria-live="polite"></div>
    </div>

    <main id="wordsContainer" aria-live="polite"></main>

    <!-- Modal & Thesaurus roots -->
    <div id="modalOverlay" class="hidden"></div>
    <div id="thesaurusOverlay" class="hidden"></div>
  </div>

  <!-- Global fixed modal navigation (non-invasive) -->
  <nav id="modalGlobalNav" aria-hidden="true" aria-label="Modal navigation">
    <button id="globalBack" class="light" title="Back">⟵</button>
    <button id="globalForward" class="light" title="Forward">⟶</button>
    <button id="globalPrev" title="Prev">◀</button>
    <button id="globalNext" title="Next">▶</button>
    <button id="globalClose" class="light" title="Close">✕</button>
  </nav>

  <script>
  // ==========================
  // Data + state (read‑only)
  // ==========================
  let currentDocs = [];          // { id, word, definitions:[{pos,meaning,synonyms,antonyms,example}], synonyms, antonyms, tags, otherForms, stars, createdAt }
  let tagSet = new Set();
  let activeTagFilter = null;
  let activePosFilter = null;
  let activeStarFilter = null; // 1/2/3 or null

  // DOM
  const jsonFile = document.getElementById('jsonFile');
  const btnAutoLoad = document.getElementById('btnAutoLoad');
  const searchEl = document.getElementById('search');
  const btnClear = document.getElementById('btnClear');
  const wordsContainer = document.getElementById('wordsContainer');
  const wordCountEl = document.getElementById('wordCount');
  const btnPrintable = document.getElementById('btnPrintable');
  const btnThesaurus = document.getElementById('btnThesaurus');
  const thesaurusOverlay = document.getElementById('thesaurusOverlay');
  const activeFilterContainer = document.getElementById('activeFilterContainer');
  const btnLayout = document.getElementById('btnLayout');
  const modalOverlay = document.getElementById('modalOverlay');

  // ------------- Utils -------------
  const arr = (v)=> (v||'').split(',').map(s=>s.trim()).filter(Boolean);
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function capitalizeLabel(s){ s = (s||'').toLowerCase(); return s.charAt(0).toUpperCase()+s.slice(1); }
  function toMillis(x){
    if(!x) return 0;
    if(typeof x === 'number') return x;
    if(typeof x === 'string' && /\d{4}-\d{2}-\d{2}/.test(x)) return Date.parse(x)||0;
    if(typeof x === 'object' && ('seconds' in x)) return x.seconds*1000 + (x.nanoseconds? Math.floor(x.nanoseconds/1e6):0);
    return 0;
  }
  function ensureIds(list){
    const used = new Set();
    list.forEach((d,i)=>{
      if(!d.id){ d.id = (d.word? d.word.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') : 'item') + '-' + i; }
      while(used.has(d.id)) d.id += '-x';
      used.add(d.id);
    });
    return list;
  }

  // Linkify any [word] or {word} in meanings into inline tokens
  function linkifyText(txt){
    if(!txt) return '';
    return escapeHtml(String(txt)).replace(/\[(.+?)\]|\{(.+?)\}/g,(m,a,b)=>{
      const token = escapeHtml((a||b||'').trim());
      return `<span class="token xref" data-xref="${token}">${token}</span>`;
    });
  }

  // ------------- Layout control -------------
  const LAYOUTS = [
    { key:'compact', label:'Compact', cols:'repeat(3,1fr)', gap:'12px', height:'12rem' },
    { key:'normal',  label:'Normal',  cols:'repeat(2,1fr)', gap:'20px', height:'17.5rem' },
    { key:'large',   label:'Large',   cols:'repeat(1,1fr)', gap:'22px', height:'22rem' }
  ];
  let currentLayoutIndex = 1;
  function applyLayout(i){
    const l = LAYOUTS[i];
    wordsContainer.style.gridTemplateColumns = l.cols;
    wordsContainer.style.gap = l.gap;
    wordsContainer.style.setProperty('--card-height', l.height);
    btnLayout.textContent = `Size: ${l.label}`;
    localStorage.setItem('mwv_layout', l.key);
    currentLayoutIndex = i;
  }
  (function initLayout(){
    const saved = localStorage.getItem('mwv_layout');
    let idx = LAYOUTS.findIndex(x=>x.key===saved);
    if(idx===-1) idx=1;
    applyLayout(idx);
  })();
  btnLayout.onclick = () => applyLayout((currentLayoutIndex+1)%LAYOUTS.length);

  // ------------- Rendering -------------
  function updateTagSetFromDocs(){
    tagSet = new Set();
    currentDocs.forEach(d => (d.tags||[]).forEach(t => t && tagSet.add(String(t))));
  }

  function renderStars(n){ n = Number(n)||0; return `<span class="stars">${[1,2,3].map(i=>`<span class="${i<=n?'f':'e'}">★</span>`).join('')}</span>`; }

  function buildDefsHtmlForDisplay(w, forModal){
    const defs = Array.isArray(w.definitions) ? w.definitions : (w.meaning ? [{pos:'noun', meaning:w.meaning}] : []);
    return defs.map((d,i)=>{
      const synArr = (d.synonyms&&d.synonyms.length)? d.synonyms: (w.synonyms||[]);
      const antArr = (d.antonyms&&d.antonyms.length)? d.antonyms: (w.antonyms||[]);
      const synBlock = synArr && synArr.length ? `<div style="margin-top:8px;"><div style="font-weight:800;margin-bottom:6px;color:${forModal?'#0f172a':'#fff'};">Synonyms</div><div>${synArr.map(s=>`<span class=\"pill syn token\" data-type=\"syn\">${escapeHtml(s)}</span>`).join('')}</div></div>`:'';
      const antBlock = antArr && antArr.length ? `<div style="margin-top:8px;"><div style="font-weight:800;margin-bottom:6px;color:${forModal?'#0f172a':'#fff'};">Antonyms</div><div>${antArr.map(a=>`<span class=\"pill ant token\" data-type=\"ant\">${escapeHtml(a)}</span>`).join('')}</div></div>`:'';
      const exampleBlock = d.example ? `<div style="margin-top:8px;"><div style="font-weight:800;margin-bottom:6px;color:${forModal?'#0f172a':'#fff'};">Example</div><div>${escapeHtml(d.example)}</div></div>` : '';
      return `
        <div class="def">
          <div class="num">${i+1}</div>
          <div style="flex:1">
            <div style="margin-bottom:6px">
              <span class="pos ${escapeHtml((d.pos||'noun').toLowerCase())}" data-pos="${escapeHtml(d.pos||'noun')}">${escapeHtml(capitalizeLabel(d.pos||'noun'))}</span>
            </div>
            <div class="def-text">${linkifyText(d.meaning||'')}</div>
            ${synBlock}
            ${antBlock}
            ${exampleBlock}
          </div>
        </div>`;
    }).join('');
  }

  function getFilteredDocs(){
    const qText = (searchEl.value||'').toLowerCase().trim();
    return currentDocs.filter(w=>{
      if(activeTagFilter){
        const tags = (w.tags||[]).map(t=>(t||'').toLowerCase());
        if(!tags.includes(activeTagFilter.toLowerCase())) return false;
      }
      if(activePosFilter){
        const defs = Array.isArray(w.definitions) ? w.definitions : [];
        const hasPos = defs.some(d=> (d.pos||'').toLowerCase() === activePosFilter.toLowerCase());
        if(!hasPos) return false;
      }
      if(activeStarFilter!==null){ if(Number(w.stars||0)!==Number(activeStarFilter)) return false; }
      if(!qText) return true;
      const parts = [w.word, ...(w.tags||[]), ...(w.synonyms||[]), ...(w.antonyms||[]), ...(w.otherForms||[])];
      if(Array.isArray(w.definitions)) for(const d of w.definitions) parts.push(d.meaning, d.pos, ...(d.synonyms||[]), ...(d.antonyms||[]));
      return parts.join(' ').toLowerCase().includes(qText);
    });
  }

  function renderActiveFilterUI(){
    const bits = [];
    if(activeTagFilter) bits.push(`<span class="chip">Tag: ${escapeHtml(activeTagFilter)} <button id=\"clearTagFilterBtn\">×</button></span>`);
    if(activePosFilter) bits.push(`<span class="chip">POS: ${escapeHtml(capitalizeLabel(activePosFilter))} <button id=\"clearPosFilterBtn\">×</button></span>`);
    if(activeStarFilter) bits.push(`<span class="chip">Stars: ${'★'.repeat(activeStarFilter)} <button id=\"clearStarFilterBtn\">×</button></span>`);
    activeFilterContainer.innerHTML = bits.join(' ');
    document.getElementById('clearTagFilterBtn')?.addEventListener('click', ()=>{activeTagFilter=null; renderActiveFilterUI(); renderCards();});
    document.getElementById('clearPosFilterBtn')?.addEventListener('click', ()=>{activePosFilter=null; renderActiveFilterUI(); renderCards();});
    document.getElementById('clearStarFilterBtn')?.addEventListener('click', ()=>{activeStarFilter=null; renderActiveFilterUI(); renderCards();});
  }

  function renderCards(){
    const docs = getFilteredDocs();
    wordCountEl.textContent = currentDocs.length;
    if(!docs.length){ wordsContainer.innerHTML = `<div class="subtle" style="font-style:italic">No words found. Load a JSON or adjust filters.</div>`; return; }
    wordsContainer.innerHTML = '';

    docs.forEach((w)=>{
      const card = document.createElement('article');
      card.className = 'card';
      card.dataset.id = w.id;
      const defs = Array.isArray(w.definitions) ? w.definitions : [];
      const firstDef = defs[0]?.meaning || '';
      const tagsHtml = (w.tags||[]).map(t=>`<span class=\"pill tag token\" data-type=\"tag\">${escapeHtml(t)}</span>`).join('');
      const otherForms = (w.otherForms||[]).map(f=>{
        const m = String(f).match(/^(.*?)\s*\((.+)\)$/);
        if(m){ return `<span class=\"pill form token\" data-type=\"form\">${escapeHtml(m[1].trim())}<span class=\"lbl\">${escapeHtml(m[2].trim())}</span></span>`; }
        return `<span class=\"pill form token\" data-type=\"form\">${escapeHtml(f)}</span>`;
      }).join(' ');

      card.innerHTML = `
        <div class="card-in">
          <div class="head">
            <div class="word">${escapeHtml(w.word||'')}</div>
            <div class="stars" title="Rating (read‑only)">${renderStars(w.stars||0)}</div>
          </div>
          <div class="meta">${tagsHtml} ${otherForms}</div>
          <div class="body">
            ${firstDef ? `<div class=\"def-text\">${linkifyText(firstDef)}</div>` : `<div class=\"subtle\">No definition preview</div>`}
          </div>
          <div class="dot" title="Open"></div>
        </div>`;

      wordsContainer.appendChild(card);
    });

    // wiring
    wordsContainer.querySelectorAll('.dot').forEach(dot=>{
      dot.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        const id = dot.closest('.card')?.dataset.id; if(id) openModalForWord(id);
      });
    });
    wordsContainer.querySelectorAll('.token').forEach(wireToken);
  }

  function wireToken(el){
    const tokenText = (el.textContent||'').trim(); if(!tokenText) return;
    el.onclick = null; el.onkeydown = null; el.classList.remove('clickable','disabled');
    const type = el.getAttribute('data-type') || '';

    if(type==='tag'){
      el.classList.add('clickable'); el.tabIndex=0;
      el.onclick = (e)=>{e.stopPropagation(); activeTagFilter=tokenText; renderActiveFilterUI(); renderCards();};
      el.onkeydown = (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); activeTagFilter=tokenText; renderActiveFilterUI(); renderCards(); }};
      return;
    }
    if(type==='form'){
      const base = tokenText.replace(/\s*\(.*\)\s*$/, '').trim();
      const found = currentDocs.find(d => (d.word||'').toLowerCase() === base.toLowerCase());
      if(found){ el.classList.add('clickable'); el.tabIndex=0; el.onclick = (e)=>{e.stopPropagation(); openModalForWord(found.id)}; el.onkeydown=(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openModalForWord(found.id); } } }
      else { el.classList.add('disabled'); el.tabIndex=-1 }
      return;
    }
    // generic (syn/ant/inline xref)
    const found = currentDocs.find(d => (d.word||'').toLowerCase() === tokenText.toLowerCase());
    if(found){ el.classList.add('clickable'); el.tabIndex=0; el.onclick=(e)=>{e.stopPropagation(); openModalForWord(found.id)}; el.onkeydown=(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openModalForWord(found.id); } } }
    else { el.classList.add('disabled'); el.tabIndex=-1 }
  }

  // ------------- Modal -------------
  let modalVisibleDocs = []; let modalCurrentIndex = -1; let modalKeyHandler = null;
  function openModalForWord(id){
    const w = currentDocs.find(x=>x.id===id); if(!w) return;
    modalOverlay.innerHTML = '';
    const outer = document.createElement('div'); outer.className='overlay'; outer.id='__modalOverlayInner';

    modalVisibleDocs = getFilteredDocs();
    modalCurrentIndex = modalVisibleDocs.findIndex(x=>x.id===id);
    if(modalCurrentIndex===-1){ modalVisibleDocs = currentDocs.slice(); modalCurrentIndex = modalVisibleDocs.findIndex(x=>x.id===id); }

    const defsHtml = buildDefsHtmlForDisplay(w,true);
    const tagsHtml = (w.tags||[]).map(t=>`<span class=\"pill tag token\" data-type=\"tag\">${escapeHtml(t)}</span>`).join('');
    const formsHtml = (w.otherForms||[]).map(f=>{
      const m = String(f).match(/^(.*?)\s*\((.+)\)$/); if(m){
        return `<span class=\"pill form token\" data-type=\"form\">${escapeHtml(m[1].trim())}<span class=\"lbl\">${escapeHtml(m[2].trim())}</span></span>`;
      }
      return `<span class=\"pill form token\" data-type=\"form\">${escapeHtml(f)}</span>`; }).join(' ');

    outer.innerHTML = `
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <div>
            <div style="font-weight:900;font-size:1.6rem;color:#0f172a;">${escapeHtml(w.word)}</div>
            <div style="margin-top:6px;" class="other-forms">${tagsHtml} ${formsHtml}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            <div id="modalPosition" style="font-weight:800;min-width:60px;text-align:center;color:#374151;">${modalCurrentIndex+1} / ${modalVisibleDocs.length}</div>
            <div title="Rating (read‑only)">${renderStars(w.stars||0)}</div>
            <button id="modalPrev" class="btn-outline" title="Previous">◀</button>
            <button id="modalNext" class="btn-outline" title="Next">▶</button>
            <button id="modalCloseBtn" class="close" title="Close">✕</button>
          </div>
        </div>
        <div style="margin-top:14px;max-height:56vh;overflow:auto;padding-right:6px;">
          ${ defsHtml || '<div class="def"><div class="def-text">No definitions.</div></div>' }
        </div>
      </div>`;

    modalOverlay.appendChild(outer);

    const prevBtn = outer.querySelector('#modalPrev');
    const nextBtn = outer.querySelector('#modalNext');
    const updatePos = ()=>{ const el = outer.querySelector('#modalPosition'); if(el) el.textContent = `${modalCurrentIndex+1} / ${modalVisibleDocs.length}`; };
    prevBtn.onclick = (e)=>{ e.stopPropagation(); if(!modalVisibleDocs.length) return; const i=(modalCurrentIndex-1+modalVisibleDocs.length)%modalVisibleDocs.length; openModalForWord(modalVisibleDocs[i].id); };
    nextBtn.onclick = (e)=>{ e.stopPropagation(); if(!modalVisibleDocs.length) return; const i=(modalCurrentIndex+1)%modalVisibleDocs.length; openModalForWord(modalVisibleDocs[i].id); };
    modalKeyHandler && document.removeEventListener('keydown', modalKeyHandler);
    modalKeyHandler = (e)=>{ if(e.key==='ArrowLeft'){ prevBtn.click(); } else if(e.key==='ArrowRight'){ nextBtn.click(); } };
    document.addEventListener('keydown', modalKeyHandler);

    outer.addEventListener('click',(e)=>{ if(e.target===outer) closeModal(); });
    outer.querySelector('#modalCloseBtn').onclick = closeModal;

    wireTokensAndBadges(outer);
    modalOverlay.classList.remove('hidden');
    document.body.style.overflow='hidden';
  }

  function closeModal(){
    modalOverlay.classList.add('hidden'); modalOverlay.innerHTML=''; document.body.style.overflow='';
    if(modalKeyHandler){ document.removeEventListener('keydown', modalKeyHandler); modalKeyHandler=null; }
  }
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  function wireTokensAndBadges(root){
    (root||document).querySelectorAll('.token').forEach(wireToken);
    (root||document).querySelectorAll('.pos').forEach(b=>{
      const posAttr = (b.getAttribute('data-pos')||b.textContent||'').trim(); if(!posAttr) return;
      b.addEventListener('click',(e)=>{ e.stopPropagation(); activePosFilter = posAttr; renderActiveFilterUI(); renderCards(); closeModal(); });
    });
  }

  // ------------- Search + filters -------------
  searchEl.addEventListener('input', ()=> renderCards());
  btnClear.addEventListener('click', ()=>{ searchEl.value=''; renderCards(); });
  document.querySelectorAll('.star-btn').forEach(b=>{
    b.onclick = ()=>{ activeStarFilter = Number(b.dataset.value||0)||null; renderActiveFilterUI(); renderCards(); };
  });
  document.getElementById('starClearBtn').onclick = ()=>{ activeStarFilter=null; renderActiveFilterUI(); renderCards(); };

  // ------------- Printable -------------
  btnPrintable.addEventListener('click', (ev)=>{ ev.preventDefault(); openPrintableWindow(); });
  function openPrintableWindow(){
    const html = buildPrintableHtml(currentDocs);
    const w = window.open('', '_blank');
    w.document.open(); w.document.write(html); w.document.close();
  }
  function buildPrintableHtml(docs){
    const css = `
      body{ font-family: Arial, Helvetica, sans-serif; margin:18px; color:#0b1220; background:#f4f6f8; }
      header{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:18px; }
      h1{ margin:0; font-size:24px; }
      .controls { display:flex; gap:8px; }
      .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
      .btn-print { background:#0b1220; color:#fff; }
      .btn-close { background:#e5e7eb; color:#0b1220; }
      main{ display:block; }
      .word-card{ background:#fff; border:1px solid #e6e9ee; padding:14px; margin-bottom:14px; border-radius:10px; box-shadow:0 6px 18px rgba(15,17,22,0.04); page-break-inside:avoid; break-inside:avoid; }
      .word-title{ font-size:18px; font-weight:800; margin-bottom:6px; }
      .tags{ margin-bottom:8px; }
      .tag{ display:inline-block; background:#e9d5ff; color:#6b21a8; padding:6px 10px; border-radius:999px; margin-right:6px; font-weight:700; font-size:12px; }
      .def-item{ background:#fff; border:1px solid #eef2ff; padding:10px; border-radius:8px; margin-bottom:8px; }
      .def-num{ display:inline-block; width:30px; height:30px; line-height:30px; text-align:center; border-radius:999px; background:#0b1220; color:#fff; font-weight:800; margin-right:8px; }
      .pos{ display:inline-block; padding:4px 8px; border-radius:6px; font-weight:700; margin-left:6px; font-size:12px; background:#f3e8ff; color:#6b21a8; }
      .meta{ margin-top:6px; font-size:13px; color:#334155; }
      .pill-syn { display:inline-block; background:#dcfce7; color:#166534; padding:6px 10px; border-radius:999px; margin-right:6px; margin-top:6px; font-weight:700; font-size:12px; }
      .pill-ant { display:inline-block; background:#fee2e2; color:#991b1b; padding:6px 10px; border-radius:999px; margin-right:6px; margin-top:6px; font-weight:700; font-size:12px; }
      @media print { .controls { display:none !important; } body{ background:#fff; margin:8mm; } }
    `;

    const bodyHtml = (docs&&docs.length) ? docs.map(function(w){
      const defs = Array.isArray(w.definitions) ? w.definitions : (w.meaning ? [{pos:'noun', meaning:w.meaning}] : []);
      const tagsHtml = (w.tags||[]).map(function(t){ return '<span class="tag">'+ escapeHtml(t) +'</span>'; }).join('');
      const defsHtml = defs.map(function(d,i){
        const synArr = (d.synonyms&&d.synonyms.length)? d.synonyms: (w.synonyms||[]);
        const antArr = (d.antonyms&&d.antonyms.length)? d.antonyms: (w.antonyms||[]);
        const synHtml = synArr.length ? synArr.map(function(s){ return '<span class="pill-syn">'+ escapeHtml(s) +'</span>'; }).join('') : '';
        const antHtml = antArr.length ? antArr.map(function(a){ return '<span class="pill-ant">'+ escapeHtml(a) +'</span>'; }).join('') : '';
        return '<div class="def-item">'
             +   '<div style="display:flex;align-items:flex-start;gap:8px;">'
             +     '<div class="def-num">' + (i+1) + '</div>'
             +     '<div style="flex:1;">'
             +       '<div style="display:flex;align-items:center;gap:8px;">'
             +         '<div style="font-weight:800">' + escapeHtml(d.meaning||'') + '</div>'
             +         '<div class="pos">' + escapeHtml(capitalizeLabel(d.pos||'noun')) + '</div>'
             +       '</div>'
             +       '<div class="meta">'
             +          (synHtml ? '<div style="margin-top:8px;"><strong>Synonyms:</strong> ' + synHtml + '</div>' : '')
             +          (antHtml ? '<div style="margin-top:8px;"><strong>Antonyms:</strong> ' + antHtml + '</div>' : '')
             +       '</div>'
             +     '</div>'
             +   '</div>'
             + '</div>';
      }).join('');
      return '<article class="word-card">'
           +   '<div class="word-title">' + escapeHtml(w.word) + '</div>'
           +   '<div class="tags">' + tagsHtml + '</div>'
           +   '<div class="definitions">' + defsHtml + '</div>'
           + '</article>';
    }).join('') : '<div>No words to print.</div>';

    return '<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Printable - My Word Vault</title><style>' + css + '</style></head><body><header><h1>My Word Vault — Printable Export</h1><div class="controls"><button class="btn btn-print" onclick="window.print();">Print</button> <button class="btn btn-close" onclick="window.close();">Close</button></div></header><main>' + bodyHtml + '</main></body></html>';
  }

  // ------------- Thesaurus (local) -------------
  btnThesaurus.addEventListener('click', (e)=>{ e.preventDefault(); openThesaurus(); });
  function openThesaurus(){
    const html = `
      <div class="overlay">
        <div class="modal">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div>
              <div style="font-weight:900;font-size:1.4rem;color:#0f172a;">Thesaurus</div>
              <div style="margin-top:6px;color:#374151;font-size:.95rem;">Search synonyms or antonyms in your vault (click results to open word)</div>
            </div>
            <button class="close" id="thesaurusClose">✕</button>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
            <input id="thesaurusQuery" class="field" placeholder="Enter a word (e.g. happy)" />
            <button id="btnThesSyn" class="btn-primary">Search Syno</button>
            <button id="btnThesAnt" class="btn-outline">Search Anto</button>
          </div>
          <div id="thesaurusResults" style="margin-top:12px;max-height:50vh;overflow:auto;"></div>
        </div>
      </div>`;
    thesaurusOverlay.innerHTML = html; thesaurusOverlay.classList.remove('hidden'); document.body.style.overflow='hidden';
    const closeBtn = thesaurusOverlay.querySelector('#thesaurusClose');
    const qEl = thesaurusOverlay.querySelector('#thesaurusQuery');
    const btnSyn = thesaurusOverlay.querySelector('#btnThesSyn');
    const btnAnt = thesaurusOverlay.querySelector('#btnThesAnt');
    const resultsEl = thesaurusOverlay.querySelector('#thesaurusResults');
    function close(){ thesaurusOverlay.classList.add('hidden'); thesaurusOverlay.innerHTML=''; document.body.style.overflow=''; }
    closeBtn.onclick = close; thesaurusOverlay.addEventListener('click',(e)=>{ if(e.target===thesaurusOverlay) close(); });
    btnSyn.onclick = ()=>{ const q=(qEl.value||'').trim(); const list = collectThesaurusResults(q,'syn'); render(list,'syn'); };
    btnAnt.onclick = ()=>{ const q=(qEl.value||'').trim(); const list = collectThesaurusResults(q,'ant'); render(list,'ant'); };
    qEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnSyn.click(); }});
    function render(list,type){ if(!list.length){ resultsEl.innerHTML = '<div class="subtle" style="font-style:italic">No results found.</div>'; return; } resultsEl.innerHTML = list.map(w=>`<div style=\"margin:6px 0;\"><span class=\"pill ${type==='syn'?'syn':'ant'} token\" data-type=\"${type}\">${escapeHtml(w)}</span></div>`).join(''); (resultsEl).querySelectorAll('.token').forEach(wireToken); }
  }
  function collectThesaurusResults(query, type){
    const q = (query||'').trim().toLowerCase(); if(!q) return [];
    const out = new Set();
    for(const d of currentDocs){
      if((d.word||'').toLowerCase()===q){
        if(type==='syn'){ (d.synonyms||[]).forEach(s=>out.add(s)); (d.definitions||[]).forEach(dd => (dd.synonyms||[]).forEach(s=>out.add(s))); }
        else { (d.antonyms||[]).forEach(a=>out.add(a)); (d.definitions||[]).forEach(dd => (dd.antonyms||[]).forEach(a=>out.add(a))); }
      }
      if(type==='syn'){
        if((d.synonyms||[]).map(s=>s.toLowerCase()).includes(q)) out.add(d.word);
        if((d.definitions||[]).some(dd => (dd.synonyms||[]).map(s=>s.toLowerCase()).includes(q))) out.add(d.word);
      } else {
        if((d.antonyms||[]).map(s=>s.toLowerCase()).includes(q)) out.add(d.word);
        if((d.definitions||[]).some(dd => (dd.antonyms||[]).map(s=>s.toLowerCase()).includes(q))) out.add(d.word);
      }
    }
    return Array.from(out).filter(Boolean).sort((a,b)=> a.localeCompare(b));
  }

  // ------------- Loading JSON -------------
  jsonFile.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    loadFromJSONText(text);
  });
  btnAutoLoad.addEventListener('click', async ()=>{
    try{ const res = await fetch('./words.json',{cache:'no-store'}); if(!res.ok) throw new Error('Missing words.json'); const text = await res.text(); loadFromJSONText(text); }
    catch(e){ alert('Could not auto‑load ./words.json. Use “Load JSON…” to pick a file manually.'); }
  });

  function loadFromJSONText(text){
    let data; try{ data = JSON.parse(text); } catch(err){ alert('Invalid JSON'); return; }
    // Accept either Array<{id?,word,...}> or { id: {word,...}, ... }
    let list;
    if(Array.isArray(data)) list = data;
    else if(data && typeof data === 'object') list = Object.entries(data).map(([id,v])=>({ id, ...(v||{}) }));
    else list = [];
    list = list.filter(d => d && d.word);
    ensureIds(list);
    // Sort: newest first (createdAt if present)
    list.sort((a,b)=> toMillis(b.createdAt) - toMillis(a.createdAt));

    currentDocs = list;
    updateTagSetFromDocs();
    renderActiveFilterUI();
    renderCards();
  }

  // ------------- Global modal nav (DOM‑driven) -------------
  (function(){
    const nav = document.getElementById('modalGlobalNav');
    const root = document.getElementById('modalOverlay');
    let backStack = []; let forwardStack = []; let currentId = null; let ignoreMutation=false;

    function findCardIdForWord(title){
      if(!title) return null; const t = String(title).toLowerCase().trim();
      const el = Array.from(document.querySelectorAll('#wordsContainer [data-id]')).find(e=>{ const id=e.getAttribute('data-id'); const w=currentDocs.find(x=>x.id===id); return w && (w.word||'').toLowerCase()===t; });
      return el? el.getAttribute('data-id'): null;
    }
    function openModalById(id){ if(!id) return false; const dot = document.querySelector(`#wordsContainer [data-id="${id}"] .dot`); if(dot){ dot.click(); return true; } const card = document.querySelector(`#wordsContainer [data-id="${id}"]`); if(card){ card.click(); return true; } return false; }

    function updateBtns(){
      document.getElementById('globalBack').disabled = backStack.length===0;
      document.getElementById('globalForward').disabled = forwardStack.length===0;
      const posPrev = !!document.querySelector('#__modalOverlayInner #modalPrev');
      const posNext = !!document.querySelector('#__modalOverlayInner #modalNext');
      document.getElementById('globalPrev').disabled = !posPrev;
      document.getElementById('globalNext').disabled = !posNext;
      if(document.body.classList.contains('modal-open')){ nav.style.display=''; nav.setAttribute('aria-hidden','false'); }
      else { nav.style.display='none'; nav.setAttribute('aria-hidden','true'); }
    }

    const mo = new MutationObserver(()=>{
      const inner = document.getElementById('__modalOverlayInner') || root.querySelector('.overlay');
      if(inner && inner.querySelector('.modal')){
        document.body.classList.add('modal-open');
        let titleEl = inner.querySelector('[style*="font-size:1.6rem"]');
        let titleText = titleEl ? (titleEl.textContent||'').trim() : null;
        const id = findCardIdForWord(titleText);
        if(id){ if(currentId && currentId!==id){ backStack.push(currentId); forwardStack.length=0; } currentId=id; }
        updateBtns();
      } else {
        document.body.classList.remove('modal-open');
        updateBtns();
      }
    });
    mo.observe(root, { childList:true, subtree:true });

    document.addEventListener('click', (e)=>{
      const t = e.target; if(!(t instanceof HTMLElement)) return;
      if(t.id==='globalBack'){ e.preventDefault(); if(!backStack.length) return; const prev = backStack.pop(); if(currentId) forwardStack.push(currentId); currentId = prev; ignoreMutation=true; openModalById(prev); setTimeout(()=>{ ignoreMutation=false; updateBtns(); }, 160); return; }
      if(t.id==='globalForward'){ e.preventDefault(); if(!forwardStack.length) return; const next = forwardStack.pop(); if(currentId) backStack.push(currentId); currentId = next; ignoreMutation=true; openModalById(next); setTimeout(()=>{ ignoreMutation=false; updateBtns(); }, 160); return; }
      if(t.id==='globalPrev'){ e.preventDefault(); const innerPrev = document.querySelector('#__modalOverlayInner #modalPrev'); if(innerPrev){ innerPrev.click(); updateBtns(); return; } return; }
      if(t.id==='globalNext'){ e.preventDefault(); const innerNext = document.querySelector('#__modalOverlayInner #modalNext'); if(innerNext){ innerNext.click(); updateBtns(); return; } return; }
      if(t.id==='globalClose'){ e.preventDefault(); const innerClose = document.querySelector('#__modalOverlayInner #modalCloseBtn') || document.querySelector('#modalOverlay .close'); if(innerClose){ innerClose.click(); document.body.classList.remove('modal-open'); updateBtns(); return; } root.innerHTML=''; root.classList.add('hidden'); document.body.style.overflow=''; document.body.classList.remove('modal-open'); updateBtns(); return; }
    });

    document.addEventListener('keydown', (e)=>{ if(!document.body.classList.contains('modal-open')) return; if(e.altKey && e.key==='ArrowLeft'){ e.preventDefault(); document.getElementById('globalBack')?.click(); } if(e.altKey && e.key==='ArrowRight'){ e.preventDefault(); document.getElementById('globalForward')?.click(); } });
    setTimeout(updateBtns, 200);
  })();

  // ------------- Kickoff -------------
  // (Optional) You can pre-bundle a small sample here for quick demo; left empty for pure offline use
  </script>
<script>
(function(){
  const nav = document.getElementById('modalGlobalNav');
  if(!nav) return;

  // Initial styling for fixed positioning
  nav.style.position = 'fixed';
  nav.style.left = '50%';
  nav.style.bottom = '16px';
  nav.style.transform = 'translateX(-50%)';
  nav.style.zIndex = 9999;
  nav.style.touchAction = 'none'; // better on mobile

  const storageKey = 'mwv_nav_pos_v2';

  // Load saved position
  function applySaved(){
    try {
      const saved = localStorage.getItem(storageKey);
      if(!saved) return;
      const p = JSON.parse(saved);
      nav.style.left = (p.left || 0) + 'px';
      nav.style.top = (p.top || 0) + 'px';
      nav.style.transform = 'none';
      nav.style.bottom = 'auto';
    } catch(e){}
  }
  applySaved();

  let dragging = false;
  let startX = 0, startY = 0;
  let origLeft = 0, origTop = 0;
  let moved = false; // to differentiate drag vs click

  function clampPosition(x, y) {
    const rect = nav.getBoundingClientRect();
    const pad = 6; // margin from edges
    const newLeft = Math.max(pad, Math.min(window.innerWidth - rect.width - pad, x));
    const newTop  = Math.max(pad, Math.min(window.innerHeight - rect.height - pad, y));
    return { left: newLeft, top: newTop };
  }

  function startDrag(clientX, clientY) {
    const rect = nav.getBoundingClientRect();
    startX = clientX;
    startY = clientY;
    origLeft = rect.left;
    origTop = rect.top;
    dragging = true;
    moved = false;
    nav.style.transition = 'none';
  }

  function moveDrag(clientX, clientY) {
    if (!dragging) return;
    const dx = clientX - startX;
    const dy = clientY - startY;
    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) moved = true;
    const { left, top } = clampPosition(origLeft + dx, origTop + dy);
    nav.style.left = left + 'px';
    nav.style.top  = top + 'px';
    nav.style.transform = 'none';
    nav.style.bottom = 'auto';
  }

  function endDrag() {
    if (!dragging) return;
    dragging = false;
    nav.style.transition = 'transform 0.05s ease-out';
    try {
      const r = nav.getBoundingClientRect();
      localStorage.setItem(storageKey, JSON.stringify({ left: Math.round(r.left), top: Math.round(r.top) }));
    } catch(e){}
  }

  // Mouse + pointer events
  nav.addEventListener('pointerdown', (ev) => {
    if (ev.target.closest('button')) return; // don't drag when tapping buttons
    startDrag(ev.clientX, ev.clientY);
  });

  document.addEventListener('pointermove', (ev) => {
    if (!dragging) return;
    moveDrag(ev.clientX, ev.clientY);
  });

  document.addEventListener('pointerup', endDrag);

  // Touch events (for older mobile Safari)
  nav.addEventListener('touchstart', (e) => {
    if (e.target.closest('button')) return;
    const t = e.touches[0];
    startDrag(t.clientX, t.clientY);
  }, { passive: true });

  nav.addEventListener('touchmove', (e) => {
    if (!dragging) return;
    const t = e.touches[0];
    moveDrag(t.clientX, t.clientY);
  }, { passive: false });

  nav.addEventListener('touchend', endDrag);

  // Double-tap to reset position
  let lastTap = 0;
  nav.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTap < 300) {
      localStorage.removeItem(storageKey);
      nav.style.left = '50%';
      nav.style.bottom = '16px';
      nav.style.top = '';
      nav.style.transform = 'translateX(-50%)';
    }
    lastTap = now;
  });

  // Re-clamp position on screen resize
  window.addEventListener('resize', () => {
    try {
      const r = nav.getBoundingClientRect();
      const { left, top } = clampPosition(r.left, r.top);
      nav.style.left = left + 'px';
      nav.style.top  = top + 'px';
      nav.style.transform = 'none';
      nav.style.bottom = 'auto';
      localStorage.setItem(storageKey, JSON.stringify({ left: Math.round(left), top: Math.round(top) }));
    } catch(e){}
  });
})();
</script>

</body>
</html>
